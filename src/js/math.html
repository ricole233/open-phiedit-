<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼“åŠ¨å‡½æ•°å¯è§†åŒ–å·¥å…·</title>
    <script src="./lib/gif.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webm-writer@0.3.0/webm-writer.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e2e8f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #4cc9f0, #4361ee, #3a0ca3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .panel {
            flex: 1;
            min-width: 300px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #60a5fa;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .canvas-container {
            position: relative;
            width: 550px;
            height: 500px;
            background: #0f172a;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 2px solid rgba(99, 102, 241, 0.3);
        }
        
        canvas {
            display: block;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .function-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 10px;
        }
        
        .func-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .func-item:hover {
            background: rgba(59, 130, 246, 0.3);
        }
        
        .func-item.active {
            background: rgba(59, 130, 246, 0.7);
        }
        
        .func-item input {
            margin-right: 8px;
        }
        
        .btn {
            padding: 12px 20px;
            background: linear-gradient(45deg, #3b82f6, #6366f1);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #64748b, #475569);
        }
        
        .btn.warning {
            background: linear-gradient(45deg, #f97316, #ef4444);
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 20px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .info-panel {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .info-panel h3 {
            margin-bottom: 10px;
            color: #60a5fa;
        }
        
        .info-panel p {
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .animation-preview {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #4cc9f0;
            border-radius: 50%;
            display: none;
        }
        
        .animation-track {
            position: absolute;
            bottom: 40px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .motion-trail {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0.6;
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        
        .export-panel {
            margin-top: 20px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 10px;
            padding: 15px;
            display: none; /* é»˜è®¤éšè— */
        }
        
        .export-panel.active {
            display: block;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .format-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }
        
        .export-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #60a5fa;
            height: 20px;
            transition: all 0.3s ease;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ç¼“åŠ¨å‡½æ•°å¯è§†åŒ–å·¥å…·</h1>
        <p class="subtitle">æ¢ç´¢28ç§ä¸åŒç¼“åŠ¨å‡½æ•°çš„å›¾åƒï¼Œäº†è§£å®ƒä»¬åœ¨åŠ¨ç”»å’Œè¿‡æ¸¡ä¸­çš„è¡Œä¸º</p>
    </header>
    
    <div class="container">
        <div class="panel">
            <h2 class="panel-title">ğŸ“ˆ å‡½æ•°å›¾åƒ</h2>
            <div class="canvas-container">
                <canvas id="graphCanvas"></canvas>
                <div class="animation-track"></div>
                <div class="animation-preview" id="animationBall"></div>
            </div>
            
            <div class="controls">
                <button id="compareBtn" class="btn">
                    <i>ğŸ“Š</i> æ·»åŠ å¯¹æ¯”
                </button>
                <button id="resetBtn" class="btn secondary">
                    <i>ğŸ”„</i> é‡ç½®å›¾è¡¨
                </button>
                <button id="animateBtn" class="btn">
                    <i>ğŸ¬</i> æ’­æ”¾åŠ¨ç”»
                </button>
                <button id="exportBtn" class="btn">
                    <i>ğŸ’¾</i> å¯¼å‡ºåŠ¨ç”»
                </button>
            </div>
            
            <div class="legend" id="legendContainer">
                <!-- å›¾ä¾‹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="export-panel" id="exportPanel">
                <h3>å¯¼å‡ºè®¾ç½®</h3>
                
                <div class="format-selector">
                    <span>æ ¼å¼ï¼š</span>
                    <label><input type="radio" name="format" value="gif" checked> GIF</label>
                    <label><input type="radio" name="format" value="webp"> WebP</label>
                </div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="showTrailCheckbox" checked>
                    <label for="showTrailCheckbox">æ˜¾ç¤ºè¿åŠ¨è½¨è¿¹</label>
                </div>
                
                <div class="checkbox-container">
                    <label for="animationSpeed">åŠ¨ç”»é€Ÿåº¦ï¼š</label>
                    <select id="animationSpeed">
                        <option value="500">æå¿« (0.5ç§’)</option>
                        <option value="1000">å¿«é€Ÿ (1ç§’)</option>
                        <option value="2000" selected>æ­£å¸¸ (2ç§’)</option>
                        <option value="3000">æ…¢é€Ÿ (3ç§’)</option>
                        <option value="5000">ææ…¢ (5ç§’)</option>
                    </select>
                </div>
                
                <div class="checkbox-container">
                    <label for="captureQuality">å¯¼å‡ºè´¨é‡ï¼š</label>
                    <select id="captureQuality">
                        <option value="low">ä½è´¨é‡ (å°æ–‡ä»¶)</option>
                        <option value="medium" selected>ä¸­ç­‰è´¨é‡</option>
                        <option value="high">é«˜è´¨é‡ (å¤§æ–‡ä»¶)</option>
                    </select>
                </div>
                
                <div class="checkbox-container">
                    <label for="coordinateMode">åæ ‡æ¨¡å¼ï¼š</label>
                    <select id="coordinateMode">
                        <option value="standard" selected>æ ‡å‡† (0,0)â†’(1,1)</option>
                        <option value="easing">ç¼“åŠ¨ (0,1)â†’(1,0)</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                
                <div id="customCoordinates" style="display: none; margin: 10px 0; padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                    <div class="coordinate-input">
                        <label>èµ·ç‚¹ X: <input type="number" id="startX" min="0" max="1" step="0.1" value="0" style="width: 60px;"></label>
                        <label>èµ·ç‚¹ Y: <input type="number" id="startY" min="0" max="1" step="0.1" value="0" style="width: 60px;"></label>
                    </div>
                    <div class="coordinate-input">
                        <label>ç»ˆç‚¹ X: <input type="number" id="endX" min="0" max="1" step="0.1" value="1" style="width: 60px;"></label>
                        <label>ç»ˆç‚¹ Y: <input type="number" id="endY" min="0" max="1" step="0.1" value="1" style="width: 60px;"></label>
                    </div>
                </div>
                
                <div class="export-options">
                    <button id="captureBtn" class="btn">
                        <i>ğŸ“·</i> æ•è·åŠ¨ç”»
                    </button>
                    <button id="closeExportBtn" class="btn secondary">
                        <i>âœ–</i> å…³é—­
                    </button>
                </div>
                
                <div class="export-status" id="exportStatus"></div>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2 class="panel-title">âš™ï¸ å‡½æ•°é€‰æ‹©</h2>
            <div class="function-selector" id="functionSelector">
                <!-- å‡½æ•°é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
            
            <div class="info-panel">
                <h3>å…³äºç¼“åŠ¨å‡½æ•°</h3>
                <p>ç¼“åŠ¨å‡½æ•°æ§åˆ¶åŠ¨ç”»è¿‡ç¨‹ä¸­æ•°å€¼å˜åŒ–çš„é€Ÿåº¦ï¼Œä½¿åŠ¨ç”»æ•ˆæœæ›´åŠ è‡ªç„¶å’Œç”ŸåŠ¨ã€‚</p>
                <p>åœ¨åŠ¨ç”»ä¸­ï¼Œçº¿æ€§å˜åŒ–ï¼ˆç¼“åŠ¨å‡½æ•°1ï¼‰é€šå¸¸æ˜¾å¾—æœºæ¢°ï¼Œè€Œéçº¿æ€§ç¼“åŠ¨å‡½æ•°å¯ä»¥åˆ›å»ºæ›´è‡ªç„¶çš„åŠ é€Ÿå’Œå‡é€Ÿæ•ˆæœã€‚</p>
                <p>é€‰æ‹©å¤šä¸ªå‡½æ•°è¿›è¡Œæ¯”è¾ƒï¼Œäº†è§£å®ƒä»¬çš„ä¸åŒç‰¹æ€§ï¼š</p>
                <ul>
                    <li>ç¼“å…¥å‡½æ•°ï¼šå¼€å§‹æ—¶ç¼“æ…¢ï¼Œç„¶ååŠ é€Ÿ</li>
                    <li>ç¼“å‡ºå‡½æ•°ï¼šå¼€å§‹æ—¶å¿«é€Ÿï¼Œç„¶åå‡é€Ÿ</li>
                    <li>ç¼“å…¥ç¼“å‡ºå‡½æ•°ï¼šå¼€å§‹å’Œç»“æŸéƒ½ç¼“æ…¢</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ç¼“åŠ¨å‡½æ•°å®šä¹‰
        const easingFunctions = [
            { id: 1, name: "çº¿æ€§", func: x => x },
            { id: 2, name: "æ­£å¼¦ç¼“å…¥", func: x => Math.sin((x * Math.PI) / 2) },
            { id: 3, name: "æ­£å¼¦ç¼“å‡º", func: x => 1 - Math.cos((x * Math.PI) / 2) },
            { id: 4, name: "äºŒæ¬¡ç¼“å‡º", func: x => 1 - (1 - x) * (1 - x) },
            { id: 5, name: "äºŒæ¬¡ç¼“å…¥", func: x => x * x },
            { id: 6, name: "ä½™å¼¦ç¼“å‡º", func: x => -(Math.cos(Math.PI * x) - 1) / 2 },
            { id: 7, name: "äºŒæ¬¡ç¼“å…¥ç¼“å‡º", func: x => x < 0.5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2 },
            { id: 8, name: "ä¸‰æ¬¡ç¼“å‡º", func: x => 1 - Math.pow(1 - x, 3) },
            { id: 9, name: "ä¸‰æ¬¡ç¼“å…¥", func: x => x * x * x },
            { id: 10, name: "å››æ¬¡ç¼“å‡º", func: x => 1 - Math.pow(1 - x, 4) },
            { id: 11, name: "å››æ¬¡ç¼“å…¥", func: x => x * x * x * x },
            { id: 12, name: "ä¸‰æ¬¡ç¼“å…¥ç¼“å‡º", func: x => x < 0.5 ? 4 * x * x * x : 1 - Math.pow(-2 * x + 2, 3) / 2 },
            { id: 13, name: "å››æ¬¡ç¼“å…¥ç¼“å‡º", func: x => x < 0.5 ? 8 * x * x * x * x : 1 - Math.pow(-2 * x + 2, 4) / 2 },
            { id: 14, name: "äº”æ¬¡ç¼“å‡º", func: x => 1 - Math.pow(1 - x, 5) },
            { id: 15, name: "äº”æ¬¡ç¼“å…¥", func: x => x * x * x * x * x },
            { id: 16, name: "æŒ‡æ•°ç¼“å‡º", func: x => x === 1 ? 1 : 1 - Math.pow(2, -10 * x) },
            { id: 17, name: "æŒ‡æ•°ç¼“å…¥", func: x => x === 0 ? 0 : Math.pow(2, 10 * x - 10) },
            { id: 18, name: "åœ†å½¢ç¼“å‡º", func: x => Math.sqrt(1 - Math.pow(x - 1, 2)) },
            { id: 19, name: "åœ†å½¢ç¼“å…¥", func: x => 1 - Math.sqrt(1 - Math.pow(x, 2)) },
            { id: 20, name: "è¿‡åº¦å›å¼¹ç¼“å‡º", func: x => 1 + 2.70158 * Math.pow(x - 1, 3) + 1.70158 * Math.pow(x - 1, 2) },
            { id: 21, name: "è¿‡åº¦å›å¼¹ç¼“å…¥", func: x => 2.70158 * x * x * x - 1.70158 * x * x },
            { id: 22, name: "åœ†å½¢ç¼“å…¥ç¼“å‡º", func: x => x < 0.5 ? (1 - Math.sqrt(1 - Math.pow(2 * x, 2))) / 2 : (Math.sqrt(1 - Math.pow(-2 * x + 2, 2)) + 1) / 2 },
            { id: 23, name: "å›å¼¹ç¼“å…¥ç¼“å‡º", func: x => x < 0.5 ? (Math.pow(2 * x, 2) * ((2.5949095 + 1) * 2 * x - 2.5949095)) / 2 : (Math.pow(2 * x - 2, 2) * ((2.5949095 + 1) * (x * 2 - 2) + 2.5949095) + 2) / 2 },
            { id: 24, name: "å¼¹æ€§ç¼“å‡º", func: x => x === 0 ? 0 : x === 1 ? 1 : Math.pow(2, -10 * x) * Math.sin((x * 10 - 0.75) * (2 * Math.PI) / 3) + 1 },
            { id: 25, name: "å¼¹æ€§ç¼“å…¥", func: x => x === 0 ? 0 : x === 1 ? 1 : -Math.pow(2, 10 * x - 10) * Math.sin((x * 10 - 10.75) * (2 * Math.PI) / 3) },
            { id: 26, name: "å¼¹è·³ç¼“å‡º", func: x => {
                const n1 = 7.5625;
                const d1 = 2.75;
                
                if (x < 1 / d1) {
                    return n1 * x * x;
                } else if (x < 2 / d1) {
                    return n1 * (x -= 1.5 / d1) * x + 0.75;
                } else if (x < 2.5 / d1) {
                    return n1 * (x -= 2.25 / d1) * x + 0.9375;
                } else {
                    return n1 * (x -= 2.625 / d1) * x + 0.984375;
                }
            }},
            { id: 27, name: "å¼¹è·³ç¼“å…¥", func: x => 1 - easingFunctions[25].func(1 - x) },
            { id: 28, name: "å¼¹è·³ç¼“å…¥ç¼“å‡º", func: x => x < 0.5 
                ? (1 - easingFunctions[25].func(1 - 2 * x)) / 2 
                : (1 + easingFunctions[25].func(2 * x - 1)) / 2 
            }
        ];

        // é¢œè‰²é›†åˆ
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFBE0B', '#FB5607', 
            '#8338EC', '#3A86FF', '#FF006E', '#38B000', '#9EF01F',
            '#FF70A6', '#70D6FF', '#FFD670', '#E9FF70', '#8AC926',
            '#1982C4', '#6A4C93', '#F15BB5', '#FEE440', '#00BBF9',
            '#00F5D4', '#9B5DE5', '#F15BB5', '#00F5D4', '#FEE440',
            '#00BBF9', '#9B5DE5', '#00F5D4'
        ];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('graphCanvas');
            const ctx = canvas.getContext('2d');
            const functionSelector = document.getElementById('functionSelector');
            const legendContainer = document.getElementById('legendContainer');
            const compareBtn = document.getElementById('compareBtn');
            const resetBtn = document.getElementById('resetBtn');
            const animateBtn = document.getElementById('animateBtn');
            const exportBtn = document.getElementById('exportBtn');
            const captureBtn = document.getElementById('captureBtn');
            const showTrailCheckbox = document.getElementById('showTrailCheckbox');
            const exportStatus = document.getElementById('exportStatus');
            const animationBall = document.getElementById('animationBall');
            const animationTrack = document.querySelector('.animation-track');
            const animationSpeed = document.getElementById('animationSpeed');
            const captureQuality = document.getElementById('captureQuality');
            const exportPanel = document.getElementById('exportPanel');
            const closeExportBtn = document.getElementById('closeExportBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            const coordinateMode = document.getElementById('coordinateMode');
            const customCoordinates = document.getElementById('customCoordinates');
            const startX = document.getElementById('startX');
            const startY = document.getElementById('startY');
            const endX = document.getElementById('endX');
            const endY = document.getElementById('endY');
            
            // è½¨è¿¹ç›¸å…³å˜é‡
            let trailElements = [];
            let isAnimating = false;
            let animationFrameId = null;
            let animationFrames = [];
            let gifRecorder = null;
            let webpRecorder = null;
            let captureMode = false;
            
            // åˆå§‹åŒ–ç”»å¸ƒå°ºå¯¸
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawFunctions(); // ç›´æ¥è°ƒç”¨drawFunctionsè€Œä¸æ˜¯drawGraph
            }
            
            // ç”Ÿæˆå‡½æ•°é€‰æ‹©å™¨
            function renderFunctionSelector() {
                functionSelector.innerHTML = '';
                easingFunctions.forEach((func, index) => {
                    const funcItem = document.createElement('div');
                    funcItem.className = 'func-item';
                    funcItem.innerHTML = `
                        <input type="checkbox" id="func-${func.id}" data-id="${func.id}">
                        <label for="func-${func.id}">${func.id}. ${func.name}</label>
                    `;
                    functionSelector.appendChild(funcItem);
                    
                    // é»˜è®¤é€‰ä¸­å‰5ä¸ªå‡½æ•°
                    if (index < 5) {
                        funcItem.querySelector('input').checked = true;
                        funcItem.classList.add('active');
                    }
                    
                    // ç‚¹å‡»äº‹ä»¶
                    funcItem.addEventListener('click', (e) => {
                        if (e.target.tagName !== 'INPUT') {
                            const checkbox = funcItem.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                        }
                        
                        funcItem.classList.toggle('active', funcItem.querySelector('input').checked);
                        drawGraph();
                    });
                });
            }
            
            // è·å–é€‰ä¸­çš„å‡½æ•°
            function getSelectedFunctions() {
                const selected = [];
                document.querySelectorAll('#functionSelector .func-item input:checked').forEach(input => {
                    const id = parseInt(input.getAttribute('data-id'));
                    const func = easingFunctions.find(f => f.id === id);
                    if (func) selected.push(func);
                });
                return selected;
            }
            
            // ç»˜åˆ¶åæ ‡ç³»
            function drawCoordinateSystem() {
                const width = canvas.width;
                const height = canvas.height;
                const padding = 60;
                const graphWidth = width - 2 * padding;
                const graphHeight = height - 2 * padding;
                
                // æ¸…é™¤ç”»å¸ƒ
                ctx.clearRect(0, 0, width, height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = '#0f172a';
                ctx.fillRect(0, 0, width, height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                ctx.strokeStyle = 'rgba(100, 116, 139, 0.2)';
                ctx.lineWidth = 1;
                
                // å‚ç›´ç½‘æ ¼çº¿
                for (let i = 0; i <= 10; i++) {
                    const x = padding + i * graphWidth / 10;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, height - padding);
                    ctx.stroke();
                }
                
                // æ°´å¹³ç½‘æ ¼çº¿
                for (let i = 0; i <= 10; i++) {
                    const y = padding + i * graphHeight / 10;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(width - padding, y);
                    ctx.stroke();
                }
                
                // ç»˜åˆ¶åæ ‡è½´
                ctx.strokeStyle = '#64748b';
                ctx.lineWidth = 2;
                
                // Xè½´
                ctx.beginPath();
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(width - padding, height - padding);
                ctx.stroke();
                
                // Yè½´
                ctx.beginPath();
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(padding, padding);
                ctx.stroke();
                
                // ç»˜åˆ¶ç®­å¤´
                ctx.beginPath();
                ctx.moveTo(width - padding, height - padding);
                ctx.lineTo(width - padding - 10, height - padding - 5);
                ctx.lineTo(width - padding - 10, height - padding + 5);
                ctx.closePath();
                ctx.fillStyle = '#64748b';
                ctx.fill();
                
                ctx.beginPath();
                ctx.moveTo(padding, padding);
                ctx.lineTo(padding - 5, padding + 10);
                ctx.lineTo(padding + 5, padding + 10);
                ctx.closePath();
                ctx.fill();
                
                // ç»˜åˆ¶åˆ»åº¦
                ctx.fillStyle = '#94a3b8';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                
                // Xè½´åˆ»åº¦
                for (let i = 0; i <= 10; i++) {
                    const x = padding + i * graphWidth / 10;
                    ctx.fillText((i / 10).toFixed(1), x, height - padding + 5);
                }
                
                // Yè½´åˆ»åº¦
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                for (let i = 0; i <= 10; i++) {
                    const y = height - padding - i * graphHeight / 10;
                    ctx.fillText((i / 10).toFixed(1), padding - 5, y);
                }
                
                // ç»˜åˆ¶åæ ‡è½´æ ‡ç­¾
                ctx.fillStyle = '#e2e8f0';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ—¶é—´ (t)', width / 2, height - 10);
                
                ctx.save();
                ctx.translate(10, height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.textAlign = 'center';
                ctx.fillText('è¿›åº¦ (p)', 0, 0);
                ctx.restore();
                
                return { padding, graphWidth, graphHeight };
            }
            
            // ç»˜åˆ¶å‡½æ•°æ›²çº¿
            function drawFunctions() {
                const selectedFuncs = getSelectedFunctions();
                const { padding, graphWidth, graphHeight } = drawCoordinateSystem();
                
                // æ›´æ–°å›¾ä¾‹
                updateLegend(selectedFuncs);
                
                // ç»˜åˆ¶å‚è€ƒçº¿ï¼ˆy=xï¼‰
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(padding, height - padding);
                ctx.lineTo(padding + graphWidth, padding);
                ctx.stroke();
                
                // è·å–å½“å‰åæ ‡æ¨¡å¼çš„èµ·ç‚¹å’Œç»ˆç‚¹
                let startPointX = 0, startPointY = 0, endPointX = 1, endPointY = 0;
                
                if (coordinateMode.value === 'standard') {
                    startPointX = 0;
                    startPointY = 0;
                    endPointX = 1;
                    endPointY = 1;
                } else if (coordinateMode.value === 'easing') {
                    startPointX = 0;
                    startPointY = 1;
                    endPointX = 1;
                    endPointY = 0;
                } else {
                    startPointX = parseFloat(startX.value) || 0;
                    startPointY = parseFloat(startY.value) || 0;
                    endPointX = parseFloat(endX.value) || 1;
                    endPointY = parseFloat(endY.value) || 1;
                }
                
                // ç»˜åˆ¶èµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°
                const startX = padding;
                const startY = height - padding - startPointY * graphHeight;
                const endX = padding + graphWidth;
                const endY = height - padding - endPointY * graphHeight;
                
                // èµ·ç‚¹æ ‡è®°
                ctx.fillStyle = '#4cc9f0';
                ctx.beginPath();
                ctx.arc(startX, startY, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // èµ·ç‚¹æ–‡å­—
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'bottom';
                ctx.fillText(`èµ·ç‚¹(${startPointX},${startPointY})`, startX + 8, startY - 5);
                
                // ç»ˆç‚¹æ ‡è®°
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.arc(endX, endY, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»ˆç‚¹æ–‡å­—
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';
                ctx.fillText(`ç»ˆç‚¹(${endPointX},${endPointY})`, endX - 8, endY - 5);
                
                // ç»˜åˆ¶é€‰ä¸­çš„å‡½æ•°
                selectedFuncs.forEach((func, index) => {
                    const color = colors[func.id - 1];
                    
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    
                    for (let i = 0; i <= graphWidth; i++) {
                        const x = i / graphWidth;
                        const y = func.func(x);
                        
                        const plotX = padding + i;
                        const plotY = height - padding - y * graphHeight;
                        
                        if (i === 0) {
                            ctx.moveTo(plotX, plotY);
                        } else {
                            ctx.lineTo(plotX, plotY);
                        }
                    }
                    
                    ctx.stroke();
                });
            }
            
            // æ›´æ–°å›¾ä¾‹
            function updateLegend(selectedFuncs) {
                legendContainer.innerHTML = '';
                
                selectedFuncs.forEach(func => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.innerHTML = `
                        <div class="legend-color" style="background-color: ${colors[func.id - 1]}"></div>
                        <span>${func.id}. ${func.name}</span>
                    `;
                    legendContainer.appendChild(legendItem);
                });
            }
            
            // ç»˜åˆ¶å›¾è¡¨
            function drawGraph() {
                // è°ƒæ•´å¤§å°ä½†ä¸å†é€’å½’è°ƒç”¨
                const container = canvas.parentElement;
                if (canvas.width !== container.clientWidth || canvas.height !== container.clientHeight) {
                    resizeCanvas();
                } else {
                    drawFunctions();
                }
            }
            
            // æ·»åŠ å¯¹æ¯”å‡½æ•°
            compareBtn.addEventListener('click', () => {
                // éšæœºé€‰æ‹©ä¸€ä¸ªæœªé€‰ä¸­çš„å‡½æ•°
                const unselected = easingFunctions.filter(func => 
                    !document.querySelector(`#functionSelector input[data-id="${func.id}"]:checked`)
                );
                
                if (unselected.length > 0) {
                    const randomFunc = unselected[Math.floor(Math.random() * unselected.length)];
                    const input = document.querySelector(`#functionSelector input[data-id="${randomFunc.id}"]`);
                    
                    if (input) {
                        input.checked = true;
                        input.parentElement.classList.add('active');
                        drawGraph();
                    }
                }
            });
            
            // é‡ç½®å›¾è¡¨
            resetBtn.addEventListener('click', () => {
                document.querySelectorAll('#functionSelector input').forEach(input => {
                    input.checked = input.dataset.id <= 28;
                    input.parentElement.classList.toggle('active', input.checked);
                });
                drawGraph();
            });
            
            // æ’­æ”¾åŠ¨ç”»
            animateBtn.addEventListener('click', () => {
                const selectedFuncs = getSelectedFunctions();
                if (selectedFuncs.length === 0) return;
                
                // æ¸…é™¤ä¹‹å‰çš„è½¨è¿¹
                clearTrail();
                
                // é‡ç½®åŠ¨ç”»çƒä½ç½®
                animationBall.style.display = 'block';
                
                // è·å–å®¹å™¨é«˜åº¦å’Œè½¨é“å®½åº¦
                const containerHeight = animationTrack.parentElement.clientHeight - 80;
                const trackWidth = animationTrack.clientWidth - 40;
                
                // æ ¹æ®åæ ‡æ¨¡å¼è®¾ç½®åˆå§‹ä½ç½®
                let initialBottom;
                
                if (coordinateMode.value === 'standard') {
                    // æ ‡å‡†æ¨¡å¼ (0,0)â†’(1,1)
                    initialBottom = 40; // åº•éƒ¨
                } else if (coordinateMode.value === 'easing') {
                    // ç¼“åŠ¨æ¨¡å¼ (0,1)â†’(1,0)
                    initialBottom = 40 + containerHeight; // é¡¶éƒ¨
                } else {
                    // è‡ªå®šä¹‰æ¨¡å¼
                    const sy = parseFloat(startY.value) || 0;
                    initialBottom = 40 + sy * containerHeight;
                }
                
                animationBall.style.bottom = `${initialBottom}px`;
                animationBall.style.left = '40px';
                animationBall.style.backgroundColor = colors[selectedFuncs[0].id - 1];
                
                const startTime = Date.now();
                const duration = parseInt(animationSpeed.value); // ä½¿ç”¨é€‰æ‹©çš„åŠ¨ç”»é€Ÿåº¦
                
                // é‡ç½®æ•è·çŠ¶æ€
                if (captureMode) {
                    animationFrames = [];
                    const format = document.querySelector('input[name="format"]:checked').value;
                    const quality = captureQuality.value;
                    
                    if (format === 'gif') {
                        // æ ¹æ®è´¨é‡è®¾ç½®å‚æ•°
                        let gifQuality = 10;
                        let gifWorkers = 2;
                        
                        if (quality === 'low') {
                            gifQuality = 1;
                            gifWorkers = 1;
                        } else if (quality === 'high') {
                            gifQuality = 20;
                            gifWorkers = 4;
                        }
                        
                        // æ£€æµ‹æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶ï¼ˆfile://åè®®ï¼‰
                        const isLocalFile = window.location.protocol === 'file:';
                        
                        if (isLocalFile) {
                            // æç¤ºç”¨æˆ·åœ¨æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨GIFå¯¼å‡º
                            exportStatus.textContent = 'æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹æ— æ³•å¯¼å‡ºGIFï¼Œè¯·ä½¿ç”¨HTTPæœåŠ¡å™¨ï¼';
                            progressBar.classList.add('active');
                            progressFill.style.width = '100%';
                            
                            // æ˜¾ç¤ºå¦‚ä½•è§£å†³çš„æç¤º
                            setTimeout(() => {
                                alert('ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œåœ¨æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹æ— æ³•ä½¿ç”¨GIFå¯¼å‡ºåŠŸèƒ½ã€‚\n\n'+
                                      'è§£å†³æ–¹æ³•ï¼š\n'+
                                      '1. ä½¿ç”¨ç®€å•çš„HTTPæœåŠ¡å™¨æä¾›æ–‡ä»¶\n'+
                                      '2. ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨Pythonå‘½ä»¤ï¼š\n'+
                                      '   python -m http.server\n'+
                                      '   ç„¶åè®¿é—® http://localhost:8000/src/js/math.html');
                                captureMode = false;
                            }, 100);
                            return;
                        }
                        
                        gifRecorder = new GIF({
                            workers: gifWorkers,
                            quality: gifQuality,
                            width: canvas.width,
                            height: canvas.height,
                            workerScript: './lib/gif.worker.js'
                        });
                        
                        gifRecorder.on('finished', function(blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = 'ç¼“åŠ¨å‡½æ•°åŠ¨ç”».gif';
                            link.click();
                            exportStatus.textContent = 'GIFå¯¼å‡ºå®Œæˆï¼';
                            captureMode = false;
                            
                            // 3ç§’åéšè—è¿›åº¦æ¡
                            setTimeout(() => {
                                progressBar.classList.remove('active');
                            }, 3000);
                        });
                        
                        gifRecorder.on('progress', function(p) {
                            exportStatus.textContent = `æ­£åœ¨ç”ŸæˆGIF... ${Math.round(p * 100)}%`;
                            // æ›´æ–°è¿›åº¦æ¡
                            progressBar.classList.add('active');
                            progressFill.style.width = `${Math.round(p * 100)}%`;
                        });
                    } else if (format === 'webp') {
                        // æ£€æµ‹æ˜¯å¦æ˜¯æœ¬åœ°æ–‡ä»¶ï¼ˆfile://åè®®ï¼‰
                        const isLocalFile = window.location.protocol === 'file:';
                        
                        if (isLocalFile) {
                            // æç¤ºç”¨æˆ·åœ¨æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨WebPå¯¼å‡º
                            exportStatus.textContent = 'æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹WebPå¯¼å‡ºå¯èƒ½ä¸æ­£å¸¸ï¼Œå»ºè®®ä½¿ç”¨HTTPæœåŠ¡å™¨ï¼';
                            progressBar.classList.add('active');
                            progressFill.style.width = '100%';
                        }
                        
                        // æ ¹æ®è´¨é‡è®¾ç½®å‚æ•°
                        let webpQuality = 0.8;
                        
                        if (quality === 'low') {
                            webpQuality = 0.6;
                        } else if (quality === 'high') {
                            webpQuality = 0.95;
                        }
                        
                        webpRecorder = new WebMWriter({
                            quality: webpQuality,
                            frameRate: 30,
                            transparent: false
                        });
                    }
                    
                    exportStatus.textContent = `æ­£åœ¨å½•åˆ¶...`;
                    progressBar.classList.add('active');
                    progressFill.style.width = '0%';
                }
                
                isAnimating = true;
                let lastFrameTime = 0;
                let frameCount = 0;
                
                function animate(timestamp) {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // ä½¿ç”¨ç¬¬ä¸€ä¸ªé€‰ä¸­çš„å‡½æ•°è®¡ç®—ä½ç½®
                    const x = selectedFuncs[0].func(progress);
                    const leftPos = 40 + progress * trackWidth;
                    
                    // æ ¹æ®åæ ‡æ¨¡å¼è®¡ç®—å‚ç›´ä½ç½®
                    let bottomPos;
                    const containerHeight = animationTrack.parentElement.clientHeight - 80;
                    
                    if (coordinateMode.value === 'standard') {
                        // æ ‡å‡†æ¨¡å¼ (0,0)â†’(1,1)
                        bottomPos = 40 + x * containerHeight;
                    } else if (coordinateMode.value === 'easing') {
                        // ç¼“åŠ¨æ¨¡å¼ (0,1)â†’(1,0)
                        bottomPos = 40 + (1 - x) * containerHeight;
                    } else {
                        // è‡ªå®šä¹‰æ¨¡å¼
                        const sx = parseFloat(startX.value) || 0;
                        const sy = parseFloat(startY.value) || 0;
                        const ex = parseFloat(endX.value) || 1;
                        const ey = parseFloat(endY.value) || 1;
                        
                        // æ ¹æ®è¿›åº¦åœ¨èµ·ç‚¹å’Œç»ˆç‚¹ä¹‹é—´æ’å€¼
                        const currentX = sx + progress * (ex - sx);
                        const currentY = sy + x * (ey - sy);
                        
                        // å°† Y åæ ‡è½¬æ¢ä¸ºç”»å¸ƒä½ç½®
                        bottomPos = 40 + currentY * containerHeight;
                    }
                    
                    animationBall.style.left = `${leftPos}px`;
                    animationBall.style.bottom = `${bottomPos}px`;
                    
                    // æ›´æ–°é¢œè‰²
                    animationBall.style.backgroundColor = colors[selectedFuncs[0].id - 1];
                    
                    // æ·»åŠ è½¨è¿¹
                    if (showTrailCheckbox.checked) {
                        addTrailPoint(leftPos, bottomPos, colors[selectedFuncs[0].id - 1]);
                    }
                    
                    // æ•è·å¸§ - æ§åˆ¶å¸§ç‡ä»¥é¿å…æ–‡ä»¶è¿‡å¤§
                    if (captureMode) {
                        const format = document.querySelector('input[name="format"]:checked').value;
                        // æ¯33msæ•è·ä¸€å¸§ï¼Œçº¦30fps
                        const currentTime = timestamp || performance.now();
                        if ((currentTime - lastFrameTime) >= 33 || progress >= 1) {
                            lastFrameTime = currentTime;
                            frameCount++;
                            
                            if (format === 'gif') {
                                // åˆ›å»ºä¸´æ—¶canvasæ¥æ•è·å½“å‰å¸§å’Œå°çƒ
                                const tempCanvas = document.createElement('canvas');
                                tempCanvas.width = canvas.width;
                                tempCanvas.height = canvas.height;
                                const tempCtx = tempCanvas.getContext('2d');
                                
                                // é¦–å…ˆç»˜åˆ¶ä¸»canvaså†…å®¹
                                tempCtx.drawImage(canvas, 0, 0);
                                
                                // ç„¶åç»˜åˆ¶å°çƒ
                                const container = document.querySelector('.canvas-container');
                                const ballRect = animationBall.getBoundingClientRect();
                                const containerRect = container.getBoundingClientRect();
                                
                                tempCtx.fillStyle = animationBall.style.backgroundColor;
                                tempCtx.beginPath();
                                tempCtx.arc(
                                    ballRect.left + 20 - containerRect.left, 
                                    ballRect.top + 20 - containerRect.top, 
                                    20, 0, Math.PI * 2
                                );
                                tempCtx.fill();
                                
                                // ç»˜åˆ¶è½¨è¿¹ç‚¹
                                if (showTrailCheckbox.checked) {
                                    document.querySelectorAll('.motion-trail').forEach(trail => {
                                        const trailRect = trail.getBoundingClientRect();
                                        tempCtx.fillStyle = trail.style.backgroundColor;
                                        tempCtx.globalAlpha = parseFloat(trail.style.opacity) || 0.6;
                                        
                                        const trailSize = parseFloat(trail.style.width) || 8;
                                        tempCtx.beginPath();
                                        tempCtx.arc(
                                            trailRect.left + trailSize/2 - containerRect.left,
                                            trailRect.top + trailSize/2 - containerRect.top,
                                            trailSize/2, 0, Math.PI * 2
                                        );
                                        tempCtx.fill();
                                    });
                                    tempCtx.globalAlpha = 1.0;
                                }
                                
                                // æ·»åŠ å¸§
                                gifRecorder.addFrame(tempCtx, {copy: true, delay: 33});
                            } else if (format === 'webp') {
                                // åˆ›å»ºä¸´æ—¶canvasæ¥æ•è·å½“å‰å¸§
                                const tempCanvas = document.createElement('canvas');
                                tempCanvas.width = canvas.width;
                                tempCanvas.height = canvas.height;
                                const tempCtx = tempCanvas.getContext('2d');
                                tempCtx.drawImage(canvas, 0, 0);
                                
                                // æ·»åŠ åŠ¨ç”»çƒ
                                const container = document.querySelector('.canvas-container');
                                const ballRect = animationBall.getBoundingClientRect();
                                const containerRect = container.getBoundingClientRect();
                                
                                tempCtx.fillStyle = animationBall.style.backgroundColor;
                                tempCtx.beginPath();
                                
                                // ä½¿ç”¨å®é™…ä½ç½®ç¡®ä¿åæ ‡å‡†ç¡®
                                const ballX = ballRect.left + 20 - containerRect.left;
                                const ballY = ballRect.top + 20 - containerRect.top;
                                
                                tempCtx.arc(
                                    ballX, 
                                    ballY, 
                                    20, 0, Math.PI * 2
                                );
                                tempCtx.fill();
                                
                                webpRecorder.addFrame(tempCanvas);
                            }
                        }
                    }
                    
                    if (progress < 1) {
                        animationFrameId = requestAnimationFrame(animate);
                    } else {
                        // åŠ¨ç”»å®Œæˆ
                        isAnimating = false;
                        
                        // å®Œæˆæ•è·
                        if (captureMode) {
                            const format = document.querySelector('input[name="format"]:checked').value;
                            
                            if (format === 'gif') {
                                // ç¡®ä¿è‡³å°‘æœ‰å‡ å¸§
                                if (frameCount < 5) {
                                    // å¦‚æœå¸§å¤ªå°‘ï¼Œå¤šåŠ å‡ å¸§ç»“å°¾çŠ¶æ€
                                    for (let i = 0; i < 5; i++) {
                                        // åˆ›å»ºä¸´æ—¶canvas
                                        const tempCanvas = document.createElement('canvas');
                                        tempCanvas.width = canvas.width;
                                        tempCanvas.height = canvas.height;
                                        const tempCtx = tempCanvas.getContext('2d');
                                        
                                        // ç»˜åˆ¶ä¸»canvaså†…å®¹
                                        tempCtx.drawImage(canvas, 0, 0);
                                        
                                        // ç»˜åˆ¶å°çƒï¼ˆåœ¨æœ€ç»ˆä½ç½®ï¼‰
                                        const container = document.querySelector('.canvas-container');
                                        const containerRect = container.getBoundingClientRect();
                                        
                                        tempCtx.fillStyle = colors[selectedFuncs[0].id - 1];
                                        
                                        // å°çƒåœ¨ç»“æŸä½ç½®
                                        const trackWidth = animationTrack.clientWidth - 40;
                                        const endX = 40 + trackWidth;
                                        
                                        // æ ¹æ®åæ ‡æ¨¡å¼è®¡ç®—å‚ç›´ä½ç½®
                                        let endY;
                                        const containerHeight = animationTrack.parentElement.clientHeight - 80;
                                        
                                        if (coordinateMode.value === 'standard') {
                                            // æ ‡å‡†æ¨¡å¼ (0,0)â†’(1,1)
                                            endY = 40 + selectedFuncs[0].func(1) * containerHeight;
                                        } else if (coordinateMode.value === 'easing') {
                                            // ç¼“åŠ¨æ¨¡å¼ (0,1)â†’(1,0)
                                            endY = 40 + (1 - selectedFuncs[0].func(1)) * containerHeight;
                                        } else {
                                            // è‡ªå®šä¹‰æ¨¡å¼
                                            const sx = parseFloat(startX.value) || 0;
                                            const sy = parseFloat(startY.value) || 0;
                                            const ex = parseFloat(endX.value) || 1;
                                            const ey = parseFloat(endY.value) || 1;
                                            
                                            // ç»ˆç‚¹çš„ Y åæ ‡
                                            const finalY = sy + selectedFuncs[0].func(1) * (ey - sy);
                                            endY = 40 + finalY * containerHeight;
                                        }
                                        
                                        // ç»˜åˆ¶å°çƒ
                                        tempCtx.beginPath();
                                        tempCtx.arc(
                                            endX + 20, 
                                            canvas.height - endY - 20, 
                                            20, 0, Math.PI * 2
                                        );
                                        tempCtx.fill();
                                        
                                        // æ·»åŠ å¸§
                                        gifRecorder.addFrame(tempCtx, {copy: true, delay: 100});
                                    }
                                }
                                
                                // æ·»åŠ å»¶è¿Ÿä»¥ç¡®ä¿æ‰€æœ‰å¸§éƒ½è¢«æ•è·
                                setTimeout(() => {
                                    exportStatus.textContent = 'æ­£åœ¨ç”ŸæˆGIF...';
                                    gifRecorder.render();
                                }, 100);
                            } else if (format === 'webp') {
                                exportStatus.textContent = 'æ­£åœ¨ç”ŸæˆWebP...';
                                progressFill.style.width = '50%'; // æ˜¾ç¤ºè¿›åº¦
                                
                                // æ·»åŠ å»¶è¿Ÿä»¥ç¡®ä¿æ‰€æœ‰å¸§éƒ½è¢«æ•è·
                                setTimeout(() => {
                                    webpRecorder.complete().then(function(webpBlob) {
                                        progressFill.style.width = '100%'; // æ˜¾ç¤ºè¿›åº¦
                                        const url = URL.createObjectURL(webpBlob);
                                        const link = document.createElement('a');
                                        link.href = url;
                                        link.download = 'ç¼“åŠ¨å‡½æ•°åŠ¨ç”».webm';
                                        link.click();
                                        exportStatus.textContent = 'WebPå¯¼å‡ºå®Œæˆï¼';
                                        captureMode = false;
                                        
                                        // 3ç§’åéšè—è¿›åº¦æ¡
                                        setTimeout(() => {
                                            progressBar.classList.remove('active');
                                        }, 3000);
                                    }).catch(function(error) {
                                        exportStatus.textContent = 'å¯¼å‡ºå¤±è´¥: ' + error;
                                        captureMode = false;
                                        progressBar.classList.remove('active');
                                    });
                                }, 100);
                            }
                        }
                        
                        // åŠ¨ç”»å®Œæˆåéšè—
                        setTimeout(() => {
                            animationBall.style.display = 'none';
                        }, 300);
                    }
                }
                
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                }
                
                animationFrameId = requestAnimationFrame(animate);
            });
            
            // æ·»åŠ è½¨è¿¹ç‚¹
            function addTrailPoint(x, y, color) {
                const container = document.querySelector('.canvas-container');
                const trail = document.createElement('div');
                trail.className = 'motion-trail';
                trail.style.left = `${x + 16}px`; // è°ƒæ•´ä½ç½®ä½¿å…¶å±…ä¸­
                trail.style.bottom = `${y + 16}px`;
                trail.style.backgroundColor = color;
                
                // æ ¹æ®å½“å‰ä½ç½®è®¾ç½®è½¨è¿¹ç‚¹å¤§å°ï¼Œé è¿‘ç»ˆç‚¹çš„è½¨è¿¹ç‚¹æ›´å°
                const containerWidth = container.clientWidth;
                const progress = (x - 40) / (containerWidth - 80);
                const size = 8 - progress * 4; // ä»8pxå‡å°åˆ°4px
                
                trail.style.width = `${size}px`;
                trail.style.height = `${size}px`;
                trail.style.opacity = 0.7 - progress * 0.3; // ä»0.7é€æ¸å‡å°åˆ°0.4
                
                container.appendChild(trail);
                
                // æ·»åŠ åˆ°è½¨è¿¹æ•°ç»„
                trailElements.push(trail);
                
                // æ·¡å‡ºæ•ˆæœ
                setTimeout(() => {
                    trail.style.opacity = '0';
                    setTimeout(() => {
                        if (container.contains(trail)) {
                            container.removeChild(trail);
                        }
                        trailElements = trailElements.filter(el => el !== trail);
                    }, 500);
                }, 2000);
            }
            
            // æ¸…é™¤è½¨è¿¹
            function clearTrail() {
                trailElements.forEach(trail => {
                    if (trail.parentNode) {
                        trail.parentNode.removeChild(trail);
                    }
                });
                trailElements = [];
            }
            
            // å¯¼å‡ºåŠ¨ç”»æŒ‰é’®äº‹ä»¶
            exportBtn.addEventListener('click', () => {
                exportPanel.classList.toggle('active');
                if (exportPanel.classList.contains('active')) {
                    exportStatus.textContent = 'è¯·é€‰æ‹©å¯¼å‡ºè®¾ç½®å¹¶ç‚¹å‡»"æ•è·åŠ¨ç”»"';
                }
            });
            
            // å…³é—­å¯¼å‡ºé¢æ¿
            closeExportBtn.addEventListener('click', () => {
                exportPanel.classList.remove('active');
            });
            
            // æ•è·æŒ‰é’®äº‹ä»¶
            captureBtn.addEventListener('click', () => {
                // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©å‡½æ•°
                const selectedFuncs = getSelectedFunctions();
                if (selectedFuncs.length === 0) {
                    exportStatus.textContent = 'è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªå‡½æ•°';
                    return;
                }
                
                // è·å–é€‰ä¸­çš„æ ¼å¼
                const format = document.querySelector('input[name="format"]:checked').value;
                
                if (isAnimating) {
                    exportStatus.textContent = 'è¯·ç­‰å¾…å½“å‰åŠ¨ç”»å®Œæˆ';
                    return;
                }
                
                // é‡ç½®è¿›åº¦æ¡
                progressBar.classList.remove('active');
                progressFill.style.width = '0%';
                
                captureMode = true;
                exportStatus.textContent = `å‡†å¤‡æ•è·ä¸º${format.toUpperCase()}æ ¼å¼`;
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => animateBtn.click(), 100);
            });
            
            // åæ ‡æ¨¡å¼åˆ‡æ¢
            coordinateMode.addEventListener('change', () => {
                if (coordinateMode.value === 'custom') {
                    customCoordinates.style.display = 'block';
                } else {
                    customCoordinates.style.display = 'none';
                }
                drawGraph(); // é‡æ–°ç»˜åˆ¶ä»¥åº”ç”¨æ–°çš„åæ ‡èŒƒå›´
            });

            // è‡ªå®šä¹‰åæ ‡è¾“å…¥
            startX.addEventListener('input', drawGraph);
            startY.addEventListener('input', drawGraph);
            endX.addEventListener('input', drawGraph);
            endY.addEventListener('input', drawGraph);
            
            // è½¨è¿¹æ˜¾ç¤ºå¼€å…³
            showTrailCheckbox.addEventListener('change', () => {
                if (!showTrailCheckbox.checked) {
                    clearTrail();
                }
            });
            
            // åˆå§‹æ¸²æŸ“
            window.addEventListener('resize', drawGraph);
            renderFunctionSelector();
            drawGraph();
        });
    </script>
</body>
</html>